<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./css/bulma.css" />
        <link rel="stylesheet" href="./css/style.css" />

        <title>Hurtownia Książek</title>
    </head>
    <body>        
        <section id="books" class="section"></section>

        <template id="template-book">
            <div class="container box">
                <div class="columns is-vcentered">
                    <div class="column is-2">
                        <figure class="image">
                            <img class="book-image" loading="lazy"></img>
                        </figure>
                    </div>
                    <div class="column">
                        <div class="book-title title"></div>
                        <table class="table is-fullwidth is-striped">
                            <tbody>
                                <tr>
                                    <td class="has-text-grey-dark">Autorzy</td>
                                    <td class="book-authors"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Wydawca</td>
                                    <td class="book-publisher"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Data wydania</td>
                                    <td><time class="book-publication-date"></time></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Kategorie</td>
                                    <td class="book-tags"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Oprawa</td>
                                    <td class="book-type"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">ISBN</td>
                                    <td class="book-isbn is-family-monospace"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Strony</td>
                                    <td class="book-pages"></td>
                                </tr>
                                <tr>
                                    <td class="has-text-grey-dark">Ilość</td>
                                    <td class="book-quantity"></td>
                                </tr>
                                <tr class="has-text-weight-bold">
                                    <td class="has-text-grey-dark">Cena</td>
                                    <td class="book-price"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="book-description"></div>
                </div>
            </div>
        </template>

        <script type="module">
            import * as API from "./js/api/index.js";

            const intersperse = (xs, separator) => xs.reduce((acc, x) => [...acc, x, separator()], []).slice(0, -1);
            const templateBook = document.getElementById("template-book");
            const booksElement = document.getElementById("books");

            (async () => {
                const booksResponse = await API.books.get();

                if (booksResponse.status = "ok") {
                    const books = booksResponse.data;

                    while (booksElement.firstChild) {
                        booksElement.firstChild.remove();
                    }

                    for (const book of books) {
                        const bookElement = templateBook.content.cloneNode(true);

                        bookElement.querySelector(".book-image").src = `/images/${book.image_id}`;
                        bookElement.querySelector(".book-title").textContent = book.title;
                        bookElement.querySelector(".book-authors").append(...intersperse(book.authors.map(author => {
                            const authorElement = document.createElement("a");
                            authorElement.classList.add("author");
                            authorElement.href = "#";
                            authorElement.textContent = author;

                            return authorElement;
                        }), () => document.createTextNode(", ")));
                        bookElement.querySelector(".book-publisher").append((() => {
                            const publisherElement = document.createElement("a");
                            publisherElement.classList.add("publisher");
                            publisherElement.href = "#";
                            publisherElement.textContent = book.publisher;

                            return publisherElement;
                        })());
                        bookElement.querySelector(".book-publication-date").setAttribute("datetime", book.publication_date);
                        bookElement.querySelector(".book-publication-date").textContent = book.publication_date;
                        bookElement.querySelector(".book-tags").append(...intersperse(book.tags.map(tag => {
                            const tagElement = document.createElement("a");
                            tagElement.classList.add("tag", "is-primary", "is-light");
                            tagElement.href = "#";
                            tagElement.textContent = tag;

                            return tagElement;
                        }), () => document.createTextNode(" ")));
                        bookElement.querySelector(".book-type").textContent = book.type;
                        bookElement.querySelector(".book-isbn").textContent = book.isbn;
                        bookElement.querySelector(".book-pages").textContent = book.pages;
                        bookElement.querySelector(".book-price").textContent = `${(book.price / 100.0).toFixed(2).replace(".", ",")}zł`;

                        const quantityElement = bookElement.querySelector(".book-quantity");
                        quantityElement.textContent = book.quantity;
                        
                        if (book.quantity === 0) quantityElement.classList.add("has-text-danger-dark");
                        else if (book.quantity <= 25) quantityElement.classList.add("has-text-warning-dark");
                        else quantityElement.classList.add("has-text-primary-dark");


                        if (book.description) bookElement.querySelector(".book-description").textContent = description;

                        booksElement.append(bookElement);
                    }
                }
                else console.error(booksResponse.error);
            })();
        </script>
    </body>
</html>